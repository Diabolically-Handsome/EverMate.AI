# 🐾 EverMate.AI（1.0 版本即将发布）
本地 AI 朋友 · Privacy-first · Offline whenever possible

[English (Canada)](README.en-CA.md) · [中文](README.zh-CN.md) · [Português (Brasil)](README.pt-BR.md) · [Français (Canada)](README.fr-CA.md) · [日本語](README.ja-JP.md)

## ✨ 项目简介
EverMate.AI 让“您和 AI 之间的长期陪伴对话”真正可用可管：**本地运行、默认不上传**，并用两大招牌能力——**记忆三分法 + 可扩展本地索引**——把庞杂对话组织得又快又准。

## 🍱 招牌功能（重点）
### 1) 记忆三分法（Core → Persona → Vault）
- **核心记忆（Core）**：高频主题 + AI 人设/回复模板线索（如称呼用“您”、要举例、语气温和）。多数问题直接命中核心，响应更快更稳。  
- **用户画像（Persona）**：沟通偏好、信息密度、长期兴趣与禁忌等，凝练为 ≤8 条要点；优先用本地 LLM 精炼，不可用时启发式回退。  
- **长尾记忆（Vault）**：其余细节不做巨型文档，而是像人的记忆一样**按块落盘并检索**，随用随取、短而准。  
- **冲突处理**：若历史记忆与**当下输入**冲突，以当下为准，避免被旧信息牵制。

### 2) 可扩展本地索引（Large-scale · Local · Fast）
- **分块写盘**：约 2.8K 字符/块（可调），适配百万～数百万字规模。  
- **倒排索引**：SQLite 存 `terms/postings/chunks`，WAL 模式读写稳健。  
- **BM25 检索**：命中相关块后，从块内挑**最佳原句**作为证据片段注入上下文。  
- **流式构建 & 增量更新**：拖拽导入 .docx/.txt 时边读边建；新建朋友**边聊边写**，累计到阈值自动落盘并周期性刷新核心/画像。

## 🚀 快速开始（最小路径）
1. 进入项目目录运行：`python app.py`  
2. 两种使用方式：  
   - **导入历史**：在导入页将 `.docx/.txt` 直接拖拽进去，点击“构建/重建记忆”，随后开始对话。  
   - **新建朋友**：直接开聊。每回合（“您问 + AI 答”）自动追加到索引，达到阈值后核心/画像自动刷新。  
3. 可选（画像更准）：配置本地 **Ollama**（如 `OLLAMA_URL`、`OLLAMA_MODEL`），走本地 LLM 精炼。

## 💼 工作原理（通俗易懂）
先看**核心**定风格与高频主题；再用**画像**补偏好与口味；最后从**长尾**检索出处与证据句。上下文**短而有力**。

## 🧲 导入与新建（两条路，同一内核）
- **拖拽导入**：`.docx` 走标准库解析；`.txt` 流式读取。全量建索引后即用三分记忆应答。  
- **新建朋友**：`append_turn` 每回合增量入库，默认每 **20** 个新块刷新核心/画像，越聊越懂您。

## 🔧 可调参数
- `CHUNK_CHARS`：默认 2800（块大小）；变大更省索引，变小召回更细。  
- `CORE_TOP_TERMS`：默认 50（核心里展示的高频主题数）。  
- `PERSONA_MAX_BULLETS`：默认 8（画像要点上限）。  
- `REFRESH_EVERY`：默认 20（新增多少块后自动刷新核心/画像）。  
- 检索 TopK：`retrieve(query, k)`，建议 4～8。

## 🛡️ 隐私与本地优先
默认**本地存储与推理**（可接本地 LLM），不上传对话。若切远端模型，请自行评估网络与合规策略；建议为 `memory` 目录加密与备份。

## ❓常见问题（围绕招牌功能）
- 画像还没变？—— 可能未触发刷新阈值；继续聊天或手动重建，也可调小 `REFRESH_EVERY`。  
- 想看“原话证据”？—— 可以，长尾检索会给出最相关的原句/片段。  
- 索引越来越大？—— 调大 `CHUNK_CHARS`、阶段性归档旧 `chunks`、或按朋友拆分独立 `memory` 目录。  
- 没有本地 LLM？—— 只影响画像凝练；算法有启发式回退，不中断流程。  
- 被历史“束缚”？—— 系统以**当前输入**为准；也可精修 `01_core.md` / `02_persona.md` 后重建。

## 🗺️ Roadmap（围绕三分记忆与索引继续加料）
- 混合检索：BM25 + 本地向量（bge/e5）。  
- 主题分桶与时间线：让长尾可视化、可回顾。  
- 可解释面板：展示本轮命中的核心要点、画像条目与长尾原句。  
- 记忆衰减与冲突解消：对过时内容降权，显式化“以当前输入为准”。  
- 事件抽取：把重要事实卡片化，支持结构化检索与复盘。

## 📦 目录速览
```
memory/
  index.sqlite    # 倒排索引与统计
  chunks/         # 分块文本
  uploads/        # 导入文件副本
  buffer.txt      # 增量缓冲
  01_core.md      # 核心记忆（高频、风格线索）
  02_persona.md   # 用户画像（要点）
  03_vault.md     # 长尾说明（动态检索）
```

## 📜 License
MIT（以仓库中 LICENSE 为准）

——  
您尽管开聊，其余交给 EverMate。
